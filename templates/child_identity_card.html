{% extends "base.html" %}

{% block title %}Child Identity Card - Digital QR Card System{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                    <h1 class="mb-2">üé´ Child Digital Identity Card</h1>
                    <p class="mb-0">Create unique QR codes for instant access to child health records</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Create/Manage Cards -->
        <div class="col-md-6">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìã Create Child Identity Card</h5>
                </div>
                <div class="card-body">
                    <!-- Child Selection -->
                    <div class="form-group mb-3">
                        <label for="childSelect" class="form-label">Select Child</label>
                        <select class="form-control form-control-lg" id="childSelect">
                            <option value="">-- Select a child --</option>
                        </select>
                        <small class="text-muted">Choose a child to create their digital identity card</small>
                    </div>

                    <!-- Child Info Display -->
                    <div id="childInfoBox" class="card bg-light" style="display:none;">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Name:</strong> <span id="childName"></span></p>
                                    <p><strong>Age:</strong> <span id="childAge"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Gender:</strong> <span id="childGender"></span></p>
                                    <p><strong>Village:</strong> <span id="childVillage"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Create Card Button -->
                    <div class="mt-3">
                        <button class="btn btn-success btn-lg w-100" id="createCardBtn" onclick="createChildCard()">
                            <i class="fas fa-qrcode"></i> Generate QR Card
                        </button>
                    </div>

                    <!-- Emergency Contacts Section -->
                    <hr>
                    <h6 class="mt-4 mb-3">üö® Emergency Contacts</h6>
                    
                    <div class="form-group">
                        <label for="contactName" class="form-label">Contact Name</label>
                        <input type="text" class="form-control" id="contactName" placeholder="Mother/Father/Guardian">
                    </div>

                    <div class="form-group">
                        <label for="contactPhone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="contactPhone" placeholder="10-digit phone number">
                    </div>

                    <div class="form-group">
                        <label for="contactRelation" class="form-label">Relationship</label>
                        <select class="form-control" id="contactRelation">
                            <option>Mother</option>
                            <option>Father</option>
                            <option>Guardian</option>
                            <option>Sibling</option>
                            <option>Other</option>
                        </select>
                    </div>

                    <button class="btn btn-outline-primary w-100" id="addContactBtn" onclick="addEmergencyContact()">
                        <i class="fas fa-plus"></i> Add Emergency Contact
                    </button>

                    <!-- Family Health Risks Section -->
                    <hr>
                    <h6 class="mt-4 mb-3">‚öïÔ∏è Family Health Risks</h6>

                    <div class="form-group">
                        <label for="riskCondition" class="form-label">Health Condition</label>
                        <input type="text" class="form-control" id="riskCondition" placeholder="e.g., Diabetes, Heart Disease">
                    </div>

                    <div class="form-group">
                        <label for="riskSeverity" class="form-label">Severity</label>
                        <select class="form-control" id="riskSeverity">
                            <option>Low</option>
                            <option selected>Medium</option>
                            <option>High</option>
                            <option>Critical</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="riskPrecautions" class="form-label">Precautions</label>
                        <textarea class="form-control" id="riskPrecautions" rows="2" placeholder="Special care needed..."></textarea>
                    </div>

                    <button class="btn btn-outline-warning w-100" id="addRiskBtn" onclick="addFamilyHealthRisk()">
                        <i class="fas fa-plus"></i> Add Health Risk
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Column: QR Card Display -->
        <div class="col-md-6">
            <div class="card shadow-lg">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üé´ Digital Identity Card Preview</h5>
                </div>
                <div class="card-body">
                    <div id="noCardBox" class="text-center text-muted py-5">
                        <i class="fas fa-qrcode" style="font-size: 48px; opacity: 0.3;"></i>
                        <p class="mt-3">Select a child and generate a QR card to preview</p>
                    </div>

                    <div id="cardDisplayBox" style="display:none;">
                        <!-- Digital Card Design -->
                        <div class="card" style="border: 3px solid #667eea; border-radius: 15px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                            <div class="card-body p-4">
                                <!-- Card Header -->
                                <div class="text-center mb-4">
                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px;">
                                        <h5 class="mb-1">üáÆüá≥ CHILD HEALTH IDENTITY</h5>
                                        <small id="cardNumber"></small>
                                    </div>
                                </div>

                                <!-- Child Photo Placeholder & Name -->
                                <div class="text-center mb-3">
                                    <div style="width: 80px; height: 80px; background: #ddd; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-user" style="font-size: 40px; color: #999;"></i>
                                    </div>
                                    <h5 id="cardChildName" class="mb-0"></h5>
                                    <small id="cardChildDOB" class="text-muted"></small>
                                </div>

                                <!-- QR Code Section -->
                                <div class="text-center mb-4">
                                    <img id="qrCodeImage" src="" alt="QR Code" style="width: 200px; height: 200px; border: 2px solid #333; padding: 5px; background: white; border-radius: 5px;">
                                    <p class="mt-2 small text-muted">Scan with ASHA/Anganwadi app</p>
                                </div>

                                <!-- Health Summary Cards -->
                                <div class="row mb-3">
                                    <!-- Vaccination Status -->
                                    <div class="col-md-6 mb-2">
                                        <div class="card border-info">
                                            <div class="card-body p-2">
                                                <small class="text-info"><strong>üíâ Vaccinations</strong></small>
                                                <div style="font-size: 18px; font-weight: bold;" id="vaccinationStatus">0/0</div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-info" id="vaccinationBar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Nutrition Status -->
                                    <div class="col-md-6 mb-2">
                                        <div class="card border-success">
                                            <div class="card-body p-2">
                                                <small class="text-success"><strong>ü•ó Nutrition</strong></small>
                                                <div id="nutritionStatus">Normal</div>
                                                <small id="nutritionDetails" class="text-muted"></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Emergency Contacts -->
                                <div class="mb-3" id="contactsSection" style="display:none;">
                                    <small class="text-danger"><strong>üö® Emergency</strong></small>
                                    <div id="contactsList" class="small"></div>
                                </div>

                                <!-- Family Health Risks -->
                                <div class="mb-3" id="risksSection" style="display:none;">
                                    <small class="text-warning"><strong>‚ö†Ô∏è Health Risks</strong></small>
                                    <div id="risksList" class="small"></div>
                                </div>

                                <!-- Footer -->
                                <hr>
                                <div class="text-center" style="font-size: 10px; color: #666;">
                                    <p class="mb-1">Issued by: AI Nutrition Advisor</p>
                                    <p class="mb-0">Scan QR for complete health record</p>
                                </div>
                            </div>
                        </div>

                        <!-- Download Buttons -->
                        <div class="mt-3">
                            <button class="btn btn-primary w-100 mb-2" onclick="downloadQRCode()">
                                <i class="fas fa-download"></i> Download QR Code
                            </button>
                            <button class="btn btn-secondary w-100" onclick="printCard()">
                                <i class="fas fa-print"></i> Print Card
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="alertBox" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
let selectedChildId = null;
let currentCard = null;

// Load children on page load
document.addEventListener('DOMContentLoaded', function() {
    loadChildren();
    
    // Handle child selection change
    document.getElementById('childSelect').addEventListener('change', function() {
        selectedChildId = this.value;
        if (selectedChildId) {
            loadChildInfo(selectedChildId);
        } else {
            document.getElementById('childInfoBox').style.display = 'none';
            document.getElementById('cardDisplayBox').style.display = 'none';
            document.getElementById('noCardBox').style.display = 'block';
        }
    });
});

function loadChildren() {
    fetch('/api/get-children')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('childSelect');
            select.innerHTML = '<option value="">-- Select a child --</option>';
            
            if (data.success && data.children) {
                data.children.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child.id;
                    const age = child.age_years || child.age || 'N/A';
                    const weight = child.weight_kg ? `, ${child.weight_kg}kg` : '';
                    option.textContent = `${child.name} (${age} years${weight})`;
                    select.appendChild(option);
                });
            }
        })
        .catch(err => console.error('Error loading children:', err));
}

function loadChildInfo(childId) {
    fetch(`/api/get-child/${childId}`)
        .then(res => res.json())
        .then(data => {
            if (data.success && data.child) {
                const child = data.child;
                document.getElementById('childName').textContent = child.name;
                const age = child.age_years || child.age || 'N/A';
                document.getElementById('childAge').textContent = age + ' years';
                document.getElementById('childGender').textContent = child.gender || 'N/A';
                document.getElementById('childVillage').textContent = child.village || 'N/A';
                document.getElementById('childInfoBox').style.display = 'block';
                
                // Load existing card if any
                loadChildCard(childId);
            }
        })
        .catch(err => console.error('Error loading child info:', err));
}

function createChildCard() {
    if (!selectedChildId) {
        showAlert('Please select a child first', 'warning');
        return;
    }
    
    showAlert('Generating QR card...', 'info');
    
    fetch(`/api/child-identity/create/${selectedChildId}`, {
        method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showAlert('‚úÖ Child identity card created successfully!', 'success');
            loadChildCard(selectedChildId);
        } else {
            showAlert('‚ùå Error: ' + data.message, 'danger');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showAlert('Error creating card', 'danger');
    });
}

function loadChildCard(childId) {
    fetch(`/api/child-identity/get/${childId}`)
        .then(res => res.json())
        .then(data => {
            if (data.success && data.card) {
                currentCard = data.card;
                displayCard(data.card);
            }
        })
        .catch(err => console.error('Error loading card:', err));
}

function displayCard(card) {
    const qrData = card.qr_data;
    
    // Display card info
    document.getElementById('cardNumber').textContent = 'Card #' + card.card_number;
    document.getElementById('cardChildName').textContent = qrData.name;
    document.getElementById('cardChildDOB').textContent = 'DOB: ' + (qrData.date_of_birth || 'N/A');
    
    // Display QR code image
    fetch(`/api/child-identity/qr/${qrData.child_id}`)
        .then(res => res.blob())
        .then(blob => {
            const url = URL.createObjectURL(blob);
            document.getElementById('qrCodeImage').src = url;
        });
    
    // Display vaccination status
    const vac = qrData.vaccination;
    document.getElementById('vaccinationStatus').textContent = `${vac.completed_vaccinations}/${vac.total_vaccinations}`;
    document.getElementById('vaccinationBar').style.width = vac.completion_percentage + '%';
    
    // Display nutrition status
    const nut = qrData.nutrition;
    document.getElementById('nutritionStatus').textContent = nut.nutrition_status;
    document.getElementById('nutritionDetails').textContent = `Weight: ${nut.current_weight_kg} kg | Height: ${nut.current_height_cm} cm`;
    
    // Display emergency contacts
    if (qrData.emergency_contacts && qrData.emergency_contacts.length > 0) {
        const contactsList = document.getElementById('contactsList');
        contactsList.innerHTML = '';
        qrData.emergency_contacts.forEach(contact => {
            contactsList.innerHTML += `<div>üìû ${contact.name}: ${contact.phone}</div>`;
        });
        document.getElementById('contactsSection').style.display = 'block';
    }
    
    // Display family health risks
    if (qrData.family_health_risks && qrData.family_health_risks.length > 0) {
        const risksList = document.getElementById('risksList');
        risksList.innerHTML = '';
        qrData.family_health_risks.forEach(risk => {
            risksList.innerHTML += `<div>üî¥ ${risk.condition} (${risk.severity})</div>`;
        });
        document.getElementById('risksSection').style.display = 'block';
    }
    
    document.getElementById('cardDisplayBox').style.display = 'block';
    document.getElementById('noCardBox').style.display = 'none';
}

function addEmergencyContact() {
    if (!selectedChildId) {
        showAlert('Please select a child first', 'warning');
        return;
    }
    
    const name = document.getElementById('contactName').value;
    const phone = document.getElementById('contactPhone').value;
    const relation = document.getElementById('contactRelation').value;
    
    if (!name || !phone) {
        showAlert('Please fill all fields', 'warning');
        return;
    }
    
    fetch('/api/child-identity/emergency-contact', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            child_id: parseInt(selectedChildId),
            contact_name: name,
            phone_number: phone,
            relationship: relation
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showAlert('‚úÖ Emergency contact added!', 'success');
            document.getElementById('contactName').value = '';
            document.getElementById('contactPhone').value = '';
            loadChildCard(selectedChildId);
        } else {
            showAlert('‚ùå Error: ' + data.message, 'danger');
        }
    });
}

function addFamilyHealthRisk() {
    if (!selectedChildId) {
        showAlert('Please select a child first', 'warning');
        return;
    }
    
    const condition = document.getElementById('riskCondition').value;
    const severity = document.getElementById('riskSeverity').value;
    const precautions = document.getElementById('riskPrecautions').value;
    
    if (!condition) {
        showAlert('Please enter a health condition', 'warning');
        return;
    }
    
    fetch('/api/child-identity/family-health-risk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            child_id: parseInt(selectedChildId),
            condition_name: condition,
            severity: severity,
            precautions: precautions
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showAlert('‚úÖ Family health risk added!', 'success');
            document.getElementById('riskCondition').value = '';
            document.getElementById('riskPrecautions').value = '';
            loadChildCard(selectedChildId);
        } else {
            showAlert('‚ùå Error: ' + data.message, 'danger');
        }
    });
}

function downloadQRCode() {
    if (!currentCard) return;
    
    const link = document.createElement('a');
    link.href = '/api/child-identity/qr/' + currentCard.child_id;
    link.download = `child_qr_${currentCard.card_number}.png`;
    link.click();
}

function printCard() {
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write(document.querySelector('.card').innerHTML);
    printWindow.document.close();
    printWindow.print();
}

function showAlert(message, type = 'info') {
    const alertBox = document.getElementById('alertBox');
    alertBox.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
}
</script>

<style>
.card {
    border-radius: 10px;
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.progress {
    background-color: #f0f0f0;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-primary, .btn-success {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-primary:hover, .btn-success:hover {
    background: linear-gradient(135deg, #5568d3 0%, #6a3f96 100%);
}
</style>
{% endblock %}
