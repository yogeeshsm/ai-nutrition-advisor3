{% extends "base.html" %}

{% block title %}Growth Tracking - AI Nutrition Advisor{% endblock %}

{% block content %}
<div class="text-center mb-5">
    <h1 class="display-4 fw-bold" style="color: white;">
        <i class="fas fa-child"></i> Growth Tracking
    </h1>
    <p class="lead" style="color: white; opacity: 0.9;">
        Monitor Children's Growth & Development
    </p>
</div>

<!-- Child Selection -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-user-friends"></i> Select Child
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <select class="form-select" id="childSelect" onchange="loadGrowthData()">
                    <option value="">-- Select a child --</option>
                    {% for child in children %}
                    <option value="{{ child.id }}">
                        {{ child.name }} (DOB: {{ child.date_of_birth }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addMeasurementModal">
                    <i class="fas fa-plus"></i> Add Measurement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Current Status -->
<div id="currentStatus" style="display: none;">
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <i class="fas fa-weight fa-2x mb-2"></i>
                <p>Latest Weight</p>
                <h3 id="latestWeight">-</h3>
                <small>kg</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <i class="fas fa-ruler-vertical fa-2x mb-2"></i>
                <p>Latest Height</p>
                <h3 id="latestHeight">-</h3>
                <small>cm</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <i class="fas fa-calculator fa-2x mb-2"></i>
                <p>BMI</p>
                <h3 id="latestBMI">-</h3>
                <small id="bmiStatus">-</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <i class="fas fa-heartbeat fa-2x mb-2"></i>
                <p>Nutritional Status</p>
                <h3 id="nutritionStatus">-</h3>
                <small>WHO Standards</small>
            </div>
        </div>
    </div>

    <!-- Growth Charts -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-chart-line"></i> Growth Charts
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <h6 class="text-center">Weight Over Time</h6>
                    <canvas id="weightChart"></canvas>
                </div>
                <div class="col-md-6 mb-4">
                    <h6 class="text-center">Height Over Time</h6>
                    <canvas id="heightChart"></canvas>
                </div>
                <div class="col-md-6 mb-4">
                    <h6 class="text-center">BMI Trend</h6>
                    <canvas id="bmiChart"></canvas>
                </div>
                <div class="col-md-6 mb-4">
                    <h6 class="text-center">Growth Velocity</h6>
                    <canvas id="velocityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Measurement History -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-history"></i> Measurement History
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Weight (kg)</th>
                            <th>Height (cm)</th>
                            <th>BMI</th>
                            <th>Head Circ. (cm)</th>
                            <th>MUAC (cm)</th>
                            <th>Notes</th>
                            <th>Measured By</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Measurement Modal -->
<div class="modal fade" id="addMeasurementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Add Growth Measurement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="measurementForm">
                    <input type="hidden" id="modalChildId">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Date of Measurement</label>
                            <input type="date" class="form-control" id="measurementDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Measured By</label>
                            <input type="text" class="form-control" id="measuredBy" placeholder="Name of health worker">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label"><i class="fas fa-weight"></i> Weight (kg) *</label>
                            <input type="number" step="0.01" class="form-control" id="weight" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label"><i class="fas fa-ruler-vertical"></i> Height (cm) *</label>
                            <input type="number" step="0.1" class="form-control" id="height" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Head Circumference (cm)</label>
                            <input type="number" step="0.1" class="form-control" id="headCirc">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">MUAC - Mid Upper Arm Circumference (cm)</label>
                            <input type="number" step="0.1" class="form-control" id="muac">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" rows="3" placeholder="Any observations or notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMeasurement()">
                    <i class="fas fa-save"></i> Save Measurement
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentChildData = null;

// Set today's date as default
document.getElementById('measurementDate').valueAsDate = new Date();

function loadGrowthData() {
    const childId = $('#childSelect').val();
    
    if (!childId) {
        $('#currentStatus').hide();
        return;
    }
    
    // Set child ID in modal
    $('#modalChildId').val(childId);
    
    // Fetch growth data
    $.ajax({
        url: `/api/growth-data/${childId}`,
        method: 'GET',
        success: function(data) {
            currentChildData = data;
            displayGrowthData(data);
            $('#currentStatus').show();
        },
        error: function(xhr) {
            alert('Error loading growth data: ' + (xhr.responseJSON?.error || 'Unknown error'));
        }
    });
}

function displayGrowthData(data) {
    // Display latest measurements
    if (data.latest) {
        $('#latestWeight').text(data.latest.weight_kg.toFixed(2));
        $('#latestHeight').text(data.latest.height_cm.toFixed(1));
        $('#latestBMI').text(data.latest.bmi ? data.latest.bmi.toFixed(1) : '-');
        
        // BMI status
        const bmi = data.latest.bmi;
        let bmiStatus = 'Normal';
        if (bmi < 16) bmiStatus = 'Severe Underweight';
        else if (bmi < 18.5) bmiStatus = 'Underweight';
        else if (bmi > 25) bmiStatus = 'Overweight';
        
        $('#bmiStatus').text(bmiStatus);
        $('#nutritionStatus').text(data.who_status || 'Normal');
    }
    
    // Populate history table
    let historyHTML = '';
    data.history.forEach(function(record) {
        historyHTML += `
            <tr>
                <td>${record.measurement_date}</td>
                <td>${record.weight_kg.toFixed(2)}</td>
                <td>${record.height_cm.toFixed(1)}</td>
                <td>${record.bmi ? record.bmi.toFixed(1) : '-'}</td>
                <td>${record.head_circumference_cm ? record.head_circumference_cm.toFixed(1) : '-'}</td>
                <td>${record.muac_cm ? record.muac_cm.toFixed(1) : '-'}</td>
                <td>${record.notes || '-'}</td>
                <td>${record.measured_by || '-'}</td>
            </tr>
        `;
    });
    $('#historyTableBody').html(historyHTML);
    
    // Draw charts
    drawGrowthCharts(data.chart_data);
}

function drawGrowthCharts(chartData) {
    // Weight Chart
    new Chart(document.getElementById('weightChart'), {
        type: 'line',
        data: {
            labels: chartData.dates,
            datasets: [{
                label: 'Weight (kg)',
                data: chartData.weights,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true }
            }
        }
    });
    
    // Height Chart
    new Chart(document.getElementById('heightChart'), {
        type: 'line',
        data: {
            labels: chartData.dates,
            datasets: [{
                label: 'Height (cm)',
                data: chartData.heights,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true }
            }
        }
    });
    
    // BMI Chart
    new Chart(document.getElementById('bmiChart'), {
        type: 'line',
        data: {
            labels: chartData.dates,
            datasets: [{
                label: 'BMI',
                data: chartData.bmis,
                borderColor: 'rgb(153, 102, 255)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true }
            }
        }
    });
    
    // Growth Velocity Chart
    new Chart(document.getElementById('velocityChart'), {
        type: 'bar',
        data: {
            labels: chartData.dates.slice(1),
            datasets: [
                {
                    label: 'Weight Gain (kg/month)',
                    data: chartData.weight_velocity,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)'
                },
                {
                    label: 'Height Gain (cm/month)',
                    data: chartData.height_velocity,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true }
            }
        }
    });
}

function saveMeasurement() {
    const childId = $('#modalChildId').val();
    
    if (!childId) {
        alert('Please select a child first');
        return;
    }
    
    const data = {
        child_id: childId,
        measurement_date: $('#measurementDate').val(),
        weight_kg: parseFloat($('#weight').val()),
        height_cm: parseFloat($('#height').val()),
        head_circumference_cm: $('#headCirc').val() ? parseFloat($('#headCirc').val()) : null,
        muac_cm: $('#muac').val() ? parseFloat($('#muac').val()) : null,
        notes: $('#notes').val(),
        measured_by: $('#measuredBy').val()
    };
    
    $.ajax({
        url: '/api/add-growth-measurement',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            alert('âœ… Measurement saved successfully!');
            $('#addMeasurementModal').modal('hide');
            $('#measurementForm')[0].reset();
            loadGrowthData(); // Reload data
        },
        error: function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to save measurement'));
        }
    });
}
</script>
{% endblock %}
